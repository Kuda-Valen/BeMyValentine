<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine Protocol v2.0</title>
    <!-- Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0f0c29;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .critical-bg {
            background: #7f1d1d !important;
        }

        .shake {
            animation: shake 0.15s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .step-content { display: none; }
        .step-content.active { display: flex; }

        #yesBtn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .btn-glow {
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.4);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Background Glows -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="absolute -top-24 -left-24 w-96 h-96 bg-pink-500/20 rounded-full blur-[120px]"></div>
        <div class="absolute -bottom-24 -right-24 w-96 h-96 bg-purple-500/20 rounded-full blur-[120px]"></div>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="app-card" class="glass w-full max-w-md p-8 rounded-[2rem] shadow-2xl z-10 transition-all duration-500">
        
        <!-- STEP 1: PHOTO UPLOAD -->
        <div id="step-upload" class="step-content active flex-col items-center text-center space-y-6">
            <div class="p-4 bg-pink-500/10 rounded-full">
                <i data-lucide="lock" class="w-10 h-10 text-pink-400"></i>
            </div>
            <div class="space-y-2">
                <h2 class="text-2xl font-bold tracking-widest uppercase text-white">Security Clearance</h2>
                <p class="text-xs text-gray-400 font-mono tracking-tighter">ID: MEMORY_AUTH_01</p>
            </div>
            
            <p class="text-sm text-gray-300 leading-relaxed px-4">This session is encrypted. To proceed, please upload our favorite photo together as the decryption key.</p>
            
            <label class="group relative flex flex-col items-center justify-center w-full h-56 border-2 border-dashed border-white/20 rounded-3xl cursor-pointer hover:border-pink-500/50 hover:bg-white/5 transition-all overflow-hidden">
                <div id="preview-container" class="hidden absolute inset-0 z-10">
                    <img id="photo-preview" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <p class="text-white text-xs font-bold uppercase">Update Key</p>
                    </div>
                </div>
                <div id="upload-prompt" class="flex flex-col items-center space-y-3">
                    <i data-lucide="image-plus" class="w-12 h-12 text-white/20 group-hover:text-pink-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-semibold uppercase tracking-widest text-white/40 group-hover:text-white">Select Photo</span>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </label>

            <button onclick="goToQuiz()" id="auth-btn" disabled class="w-full py-4 rounded-full font-black uppercase tracking-[0.2em] bg-white/5 text-white/20 cursor-not-allowed transition-all duration-300">
                Authenticate
            </button>
        </div>

        <!-- STEP 2: QUIZ -->
        <div id="step-quiz" class="step-content flex-col items-center text-center space-y-6">
            <i data-lucide="shield-check" class="w-12 h-12 text-pink-400"></i>
            <h2 class="text-2xl font-light tracking-widest uppercase text-white">Integrity Check</h2>
            
            <div class="w-full space-y-5 text-left">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-pink-400 ml-1">First Kiss Location</label>
                    <input type="text" id="q-loc" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-sm focus:outline-none focus:border-pink-500 focus:bg-white/10 transition-all" placeholder="Where was it?">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-pink-400 ml-1">First Kiss Date</label>
                    <input type="date" id="q-date" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-sm focus:outline-none focus:border-pink-500 focus:bg-white/10 transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-pink-400 ml-1">Future Family</label>
                    <input type="number" id="q-kids" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-sm focus:outline-none focus:border-pink-500 focus:bg-white/10 transition-all" placeholder="How many kids do I want?">
                </div>
            </div>

            <button onclick="validateQuiz()" class="w-full py-4 bg-pink-600 hover:bg-pink-500 rounded-full font-bold uppercase tracking-widest text-white shadow-[0_0_30px_rgba(219,39,119,0.4)] transition-all active:scale-95">
                Verify Identity
            </button>
        </div>

        <!-- STEP 3: VALENTINE -->
        <div id="step-valentine" class="step-content flex-col items-center text-center space-y-8">
            <div class="relative">
                <i data-lucide="heart" class="w-16 h-16 text-pink-500 animate-pulse fill-pink-500/20"></i>
                <div class="absolute inset-0 bg-pink-500/20 blur-2xl rounded-full"></div>
            </div>
            <h2 class="text-3xl font-black text-white leading-tight">Will you be my Valentine?</h2>
            
            <div class="flex items-center justify-center gap-6 w-full min-h-[120px]">
                <button id="yesBtn" onclick="celebrate()" class="px-12 py-4 bg-pink-500 rounded-full font-black text-white shadow-[0_0_30px_rgba(236,72,153,0.6)] hover:bg-pink-400 z-50 transition-transform">
                    YES
                </button>
                <button id="noBtn" onclick="triggerError('INVALID SELECTION DETECTED. SYSTEM OVERRIDE INITIATED.')" class="px-10 py-4 bg-white/10 border border-white/20 rounded-full font-bold text-white transition-all duration-200">
                    NO
                </button>
            </div>
        </div>

        <!-- STEP 4: SUCCESS -->
        <div id="step-success" class="step-content flex-col items-center text-center space-y-6">
            <div class="relative">
                <i data-lucide="heart" class="w-24 h-24 text-white fill-white animate-bounce"></i>
                <div class="absolute -top-4 -right-4 bg-white text-pink-500 p-2 rounded-full shadow-xl">
                    <i data-lucide="check" class="w-6 h-6"></i>
                </div>
            </div>
            <h1 class="text-4xl font-black text-white tracking-tighter">PROTOCOL GRANTED</h1>
            <p class="text-white/70 font-medium tracking-widest uppercase text-xs">Access fully unlocked.</p>
            <p class="text-white text-lg font-light italic leading-relaxed px-4">
                "I wish I could see you this Valentine's... even though you're across the world, my heart is right where you are."
            </p>
            
            <!-- DEBUG LOGS FOR YOU -->
            <div id="debug-log" class="mt-8 pt-4 border-t border-white/10 w-full text-[10px] font-mono text-white/30 text-left overflow-hidden">
                Status: Awaiting Trigger...
            </div>
        </div>
    </div>

    <!-- ERROR OVERLAY -->
    <div id="error-overlay" class="fixed inset-0 z-[100] hidden items-center justify-center bg-red-950/80 backdrop-blur-xl p-4">
        <div class="bg-white p-10 max-w-sm w-full border-[8px] border-red-600 text-red-600 text-center shadow-[0_0_80px_rgba(220,38,38,0.7)] shake">
            <i data-lucide="alert-octagon" class="w-20 h-20 mx-auto mb-4"></i>
            <h3 class="font-black text-4xl mb-3 tracking-tighter italic">CRITICAL FAILURE</h3>
            <p id="error-msg" class="font-bold text-sm mb-8 uppercase leading-tight tracking-tighter">
                INVALID SELECTION DETECTED. SYSTEM OVERRIDE INITIATED.
            </p>
            <button id="error-action-btn" onclick="closeError()" class="w-full bg-red-600 text-white py-5 font-black uppercase text-sm tracking-[0.2em] hover:bg-red-700 active:scale-95 transition-all shadow-lg">
                RE-ATTEMPT CLEARANCE
            </button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHTA1_SV4zJHdY7cPxrIFWywYwQ_WJkJo",
            authDomain: "bemyvalentine-28efd.firebaseapp.com",
            projectId: "bemyvalentine-28efd",
            storageBucket: "bemyvalentine-28efd.firebasestorage.app",
            messagingSenderId: "288738654455",
            appId: "1:288738654455:web:dc03d21bef1a8f6a047bf2",
            measurementId: "G-CB8KGXBZHM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'valentine-2026';

        let currentPhoto = null;
        let yesScale = 1;
        let errorCount = 0;
        let isQuizError = false;

        const messages = [
            "Nice try. Try again.",
            "Access Denied: Please rethink your choices.",
            "System Error: Redirecting to compliance mode...",
            "HEART.EXE NOT RESPONDING: SELECT 'YES' TO REPAIR"
        ];

        lucide.createIcons();

        function log(msg) {
            const el = document.getElementById('debug-log');
            if(el) el.innerText = "Status: " + msg;
            console.log(msg);
        }

        window.showStep = (stepId) => {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            const target = document.getElementById('step-' + stepId);
            target.classList.add('active');
            lucide.createIcons();
        };

        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentPhoto = event.target.result;
                    document.getElementById('photo-preview').src = currentPhoto;
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('upload-prompt').classList.add('hidden');
                    const btn = document.getElementById('auth-btn');
                    btn.disabled = false;
                    btn.classList.remove('bg-white/5', 'text-white/20', 'cursor-not-allowed');
                    btn.classList.add('bg-pink-600', 'text-white', 'btn-glow', 'hover:bg-pink-500');
                };
                reader.readAsDataURL(file);
            }
        });

        window.goToQuiz = () => showStep('quiz');
        window.goToValentine = () => showStep('valentine');

        window.validateQuiz = () => {
            const loc = document.getElementById('q-loc').value.toLowerCase();
            const date = document.getElementById('q-date').value;
            const kids = document.getElementById('q-kids').value;

            const keywords = ["car", "uber", "on way", "home"];
            const hasKeyword = keywords.some(k => loc.includes(k));
            const isCorrectDate = (date === "2025-04-19");
            const isCorrectKids = (kids == "5");

            if (!hasKeyword) {
                isQuizError = true;
                triggerError("LOCATION MISMATCH: MEMORY DATA CORRUPTED.");
            } else if (!isCorrectDate) {
                isQuizError = true;
                triggerError("DATE ERROR: CHRONOLOGY TAMPERED.");
            } else if (!isCorrectKids) {
                isQuizError = true;
                triggerError("DATA ERROR: UNEXPECTED FAMILY PARAMETERS.");
            } else {
                isQuizError = false;
                window.goToValentine();
            }
        };

        window.triggerError = (msg) => {
            document.body.classList.add('critical-bg');
            const overlay = document.getElementById('error-overlay');
            overlay.classList.replace('hidden', 'flex');
            const displayMsg = msg || messages[errorCount % messages.length];
            document.getElementById('error-msg').innerText = displayMsg;
            errorCount++;
            lucide.createIcons();
        };

        window.closeError = () => {
            document.body.classList.remove('critical-bg');
            document.getElementById('error-overlay').classList.replace('flex', 'hidden');
            if (!isQuizError) {
                yesScale += 0.6;
                document.getElementById('yesBtn').style.transform = `scale(${yesScale})`;
            }
        };

        window.celebrate = async () => {
            showStep('success');
            document.body.style.background = 'linear-gradient(to bottom right, #be123c, #881337)';
            
            log("Attempting to connect to Firebase...");

            try {
                // Wait for auth first
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                log("Authenticated. UID: " + user.uid);
                
                // Collection path MUST match the rules exactly
                const responsesRef = collection(db, 'artifacts', appId, 'public', 'data', 'responses');
                
                log("Saving data to artifacts/valentine-2026/...");
                
                const docRef = await addDoc(responsesRef, {
                    photo_base64: currentPhoto, // This saves the image into the doc
                    answers: {
                        location: document.getElementById('q-loc').value,
                        date: document.getElementById('q-date').value,
                        kids_count: document.getElementById('q-kids').value
                    },
                    timestamp: new Date().toISOString(),
                    user_id: user.uid
                });
                
                log("Success! Document ID: " + docRef.id);
            } catch (e) { 
                log("ERROR: " + e.message);
                console.error("Full Error Object:", e);
            }
        };
    </script>
</body>
</html>