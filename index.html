<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine Protocol v2.0</title>
    <!-- Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0f0c29;
            overflow: hidden;
            transition: background 0.5s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .critical-bg {
            background: #450a0a !important;
        }

        .shake {
            animation: shake 0.1s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .step-content { display: none; }
        .step-content.active { display: flex; }

        #yesBtn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Background Glows -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="absolute -top-24 -left-24 w-96 h-96 bg-pink-500/20 rounded-full blur-[120px]"></div>
        <div class="absolute -bottom-24 -right-24 w-96 h-96 bg-purple-500/20 rounded-full blur-[120px]"></div>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="app-card" class="glass w-full max-w-md p-8 rounded-[2rem] shadow-2xl z-10 transition-all duration-500">
        
        <!-- STEP 1: PHOTO UPLOAD -->
        <div id="step-upload" class="step-content active flex-col items-center text-center space-y-6">
            <i data-lucide="lock" class="w-12 h-12 text-pink-400"></i>
            <h2 class="text-2xl font-light tracking-widest uppercase text-white">Security Clearance</h2>
            <p class="text-sm text-gray-400">Authentication required. Please upload the memory that serves as our key.</p>
            
            <label class="group relative flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-white/20 rounded-2xl cursor-pointer hover:border-pink-500/50 hover:bg-white/5 transition-all">
                <div id="preview-container" class="hidden absolute inset-0">
                    <img id="photo-preview" src="" class="w-full h-full object-cover rounded-2xl">
                </div>
                <div id="upload-prompt" class="flex flex-col items-center">
                    <i data-lucide="upload" class="w-10 h-10 mb-2 text-white/30 group-hover:text-pink-400"></i>
                    <span class="text-xs uppercase tracking-tighter text-white/50">Select Favorite Memory</span>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </label>

            <button onclick="goToQuiz()" id="auth-btn" disabled class="w-full py-4 rounded-full font-bold uppercase tracking-widest bg-white/10 text-white/30 cursor-not-allowed transition-all">
                Authenticate
            </button>
        </div>

        <!-- STEP 2: QUIZ -->
        <div id="step-quiz" class="step-content flex-col items-center text-center space-y-6">
            <i data-lucide="shield-check" class="w-12 h-12 text-pink-400"></i>
            <h2 class="text-2xl font-light tracking-widest uppercase text-white">Verification</h2>
            
            <div class="w-full space-y-4 text-left">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-pink-400">Where was our first kiss?</label>
                    <input type="text" id="q-loc" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-pink-500" placeholder="Location...">
                </div>
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-pink-400">When did it happen?</label>
                    <input type="text" id="q-date" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-pink-500" placeholder="The date...">
                </div>
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-pink-400">How many kids do I want?</label>
                    <input type="text" id="q-kids" class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-pink-500" placeholder="The number...">
                </div>
            </div>

            <button onclick="goToValentine()" class="w-full py-4 bg-pink-500 rounded-full font-bold uppercase tracking-widest text-white shadow-[0_0_20px_rgba(236,72,153,0.4)]">
                Verify Integrity
            </button>
        </div>

        <!-- STEP 3: VALENTINE -->
        <div id="step-valentine" class="step-content flex-col items-center text-center space-y-8">
            <i data-lucide="heart" class="w-12 h-12 text-pink-400 animate-pulse"></i>
            <h2 class="text-3xl font-bold text-white">Will you be my Valentine?</h2>
            
            <div class="flex items-center justify-center gap-6 w-full min-h-[100px]">
                <button id="yesBtn" onclick="celebrate()" class="px-10 py-4 bg-pink-500 rounded-full font-bold text-white shadow-[0_0_25px_rgba(236,72,153,0.6)] hover:scale-110 active:scale-95 z-50">
                    YES
                </button>
                <button id="noBtn" onmouseover="moveNo()" onclick="triggerError()" class="px-10 py-4 bg-white/10 border border-white/20 rounded-full font-bold text-white transition-all duration-200">
                    NO
                </button>
            </div>
        </div>

        <!-- STEP 4: SUCCESS -->
        <div id="step-success" class="step-content flex-col items-center text-center space-y-6">
            <div class="relative">
                <i data-lucide="heart" class="w-24 h-24 text-white fill-white animate-bounce"></i>
            </div>
            <h1 class="text-4xl font-black text-white">ACCESS GRANTED</h1>
            <p class="text-white/70 tracking-widest uppercase text-sm">See you on the 14th! ðŸ’–</p>
        </div>
    </div>

    <!-- ERROR OVERLAY -->
    <div id="error-overlay" class="fixed inset-0 z-[100] hidden items-center justify-center bg-red-950/40 backdrop-blur-md p-4">
        <div class="bg-white p-8 max-w-xs w-full border-4 border-red-600 text-red-600 text-center shake">
            <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-4"></i>
            <h3 class="font-black text-2xl mb-2 tracking-tighter">CRITICAL ERROR</h3>
            <p id="error-msg" class="font-bold text-xs mb-6 uppercase">Access Denied: Try harder.</p>
            <button onclick="closeError()" class="w-full bg-red-600 text-white py-3 font-bold uppercase text-xs tracking-widest">Retry System</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse('__firebase_config');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = '__app_id' || 'valentine-2026';

        let currentPhoto = null;
        let yesScale = 1;
        let errorCount = 0;
        const messages = [
            "Nice try. Try again.",
            "Access Denied: High levels of affection detected.",
            "System Error: Redirecting to 'Yes'...",
            "FATAL ERROR: HEART.EXE NOT RESPONDING"
        ];

        // Initialize Icons
        lucide.createIcons();

        // Step Management
        window.showStep = (stepId) => {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.getElementById('step-' + stepId).classList.add('active');
        };

        // Photo Handling
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentPhoto = event.target.result;
                    document.getElementById('photo-preview').src = currentPhoto;
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('upload-prompt').classList.add('hidden');
                    const btn = document.getElementById('auth-btn');
                    btn.disabled = false;
                    btn.classList.remove('bg-white/10', 'text-white/30', 'cursor-not-allowed');
                    btn.classList.add('bg-pink-500', 'text-white', 'shadow-[0_0_20px_rgba(236,72,153,0.4)]');
                };
                reader.readAsDataURL(file);
            }
        });

        window.goToQuiz = () => showStep('quiz');
        window.goToValentine = () => showStep('valentine');

        window.moveNo = () => {
            const btn = document.getElementById('noBtn');
            const x = Math.random() * (window.innerWidth - btn.offsetWidth);
            const y = Math.random() * (window.innerHeight - btn.offsetHeight);
            btn.style.position = 'fixed';
            btn.style.left = x + 'px';
            btn.style.top = y + 'px';
        };

        window.triggerError = () => {
            document.body.classList.add('critical-bg');
            document.getElementById('error-overlay').classList.replace('hidden', 'flex');
            document.getElementById('error-msg').innerText = messages[errorCount % messages.length];
            errorCount++;
        };

        window.closeError = () => {
            document.body.classList.remove('critical-bg');
            document.getElementById('error-overlay').classList.replace('flex', 'hidden');
            yesScale += 0.3;
            document.getElementById('yesBtn').style.transform = `scale(${yesScale})`;
        };

        window.celebrate = async () => {
            showStep('success');
            document.body.style.background = 'linear-gradient(to bottom right, #f472b6, #fb7185)';
            
            // Save Data
            try {
                await signInAnonymously(auth);
                const path = `/artifacts/${appId}/public/data/responses`;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'responses'), {
                    photo: currentPhoto,
                    quiz: {
                        loc: document.getElementById('q-loc').value,
                        date: document.getElementById('q-date').value,
                        kids: document.getElementById('q-kids').value
                    },
                    timestamp: new Date().toISOString()
                });
            } catch (e) { console.error(e); }
        };
    </script>
</body>
</html>