<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine Protocol v2.0</title>
    <!-- Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0f0c29;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .critical-bg {
            background: #450a0a !important;
        }

        .shake {
            animation: shake 0.1s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .step-content { display: none; }
        .step-content.active { display: flex; }

        #yesBtn { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Custom scrollbar for small height screens */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Background Glows -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="absolute -top-24 -left-24 w-96 h-96 bg-pink-500/20 rounded-full blur-[120px]"></div>
        <div class="absolute -bottom-24 -right-24 w-96 h-96 bg-purple-500/20 rounded-full blur-[120px]"></div>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="app-card" class="glass w-full max-w-md p-8 rounded-[2rem] shadow-2xl z-10 transition-all duration-500">
        
        <!-- STEP 1: PHOTO UPLOAD -->
        <div id="step-upload" class="step-content active flex-col items-center text-center space-y-6">
            <div class="p-4 bg-pink-500/10 rounded-full">
                <i data-lucide="lock" class="w-10 h-10 text-pink-400"></i>
            </div>
            <div class="space-y-2">
                <h2 class="text-2xl font-bold tracking-widest uppercase text-white">Security Clearance</h2>
                <p class="text-xs text-gray-400">IDENTITY VERIFICATION REQUIRED</p>
            </div>
            
            <p class="text-sm text-gray-300 leading-relaxed">Please upload our favorite photo together. This memory acts as the primary decryption key for this session.</p>
            
            <label class="group relative flex flex-col items-center justify-center w-full h-56 border-2 border-dashed border-white/20 rounded-3xl cursor-pointer hover:border-pink-500/50 hover:bg-white/5 transition-all overflow-hidden">
                <div id="preview-container" class="hidden absolute inset-0 z-10">
                    <img id="photo-preview" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <p class="text-white text-xs font-bold uppercase">Change Photo</p>
                    </div>
                </div>
                <div id="upload-prompt" class="flex flex-col items-center space-y-3">
                    <i data-lucide="image-plus" class="w-12 h-12 text-white/20 group-hover:text-pink-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-xs font-semibold uppercase tracking-widest text-white/40 group-hover:text-white">Select Photo</span>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </label>

            <button onclick="goToQuiz()" id="auth-btn" disabled class="w-full py-4 rounded-full font-black uppercase tracking-[0.2em] bg-white/5 text-white/20 cursor-not-allowed transition-all duration-300">
                Authenticate
            </button>
        </div>

        <!-- STEP 2: QUIZ -->
        <div id="step-quiz" class="step-content flex-col items-center text-center space-y-6">
            <i data-lucide="shield-check" class="w-12 h-12 text-pink-400"></i>
            <h2 class="text-2xl font-light tracking-widest uppercase text-white">Secondary Auth</h2>
            
            <div class="w-full space-y-5 text-left">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-pink-400 ml-1">First Kiss Location</label>
                    <input type="text" id="q-loc" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-sm focus:outline-none focus:border-pink-500 focus:bg-white/10 transition-all" placeholder="Where did it happen?">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-pink-400 ml-1">First Kiss Date</label>
                    <input type="text" id="q-date" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-sm focus:outline-none focus:border-pink-500 focus:bg-white/10 transition-all" placeholder="When exactly?">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-pink-400 ml-1">Family Goals</label>
                    <input type="text" id="q-kids" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-sm focus:outline-none focus:border-pink-500 focus:bg-white/10 transition-all" placeholder="How many kids do I want?">
                </div>
            </div>

            <button onclick="goToValentine()" class="w-full py-4 bg-pink-600 hover:bg-pink-500 rounded-full font-bold uppercase tracking-widest text-white shadow-[0_0_30px_rgba(219,39,119,0.4)] transition-all active:scale-95">
                Verify Integrity
            </button>
        </div>

        <!-- STEP 3: VALENTINE -->
        <div id="step-valentine" class="step-content flex-col items-center text-center space-y-8">
            <div class="relative">
                <i data-lucide="heart" class="w-16 h-16 text-pink-500 animate-pulse fill-pink-500/20"></i>
                <div class="absolute inset-0 bg-pink-500/20 blur-2xl rounded-full"></div>
            </div>
            <h2 class="text-3xl font-black text-white leading-tight">Will you be my Valentine?</h2>
            
            <div class="flex items-center justify-center gap-6 w-full min-h-[120px]">
                <button id="yesBtn" onclick="celebrate()" class="px-12 py-4 bg-pink-500 rounded-full font-black text-white shadow-[0_0_30px_rgba(236,72,153,0.6)] hover:bg-pink-400 z-50 transition-transform">
                    YES
                </button>
                <button id="noBtn" onmouseover="moveNo()" onclick="triggerError()" class="px-10 py-4 bg-white/10 border border-white/20 rounded-full font-bold text-white transition-all duration-200">
                    NO
                </button>
            </div>
        </div>

        <!-- STEP 4: SUCCESS -->
        <div id="step-success" class="step-content flex-col items-center text-center space-y-6">
            <div class="relative">
                <i data-lucide="heart" class="w-24 h-24 text-white fill-white animate-bounce"></i>
                <div class="absolute -top-4 -right-4 bg-white text-pink-500 p-2 rounded-full shadow-xl">
                    <i data-lucide="check" class="w-6 h-6"></i>
                </div>
            </div>
            <h1 class="text-4xl font-black text-white tracking-tighter">PROTOCOL GRANTED</h1>
            <p class="text-white/70 font-medium tracking-widest uppercase text-xs">Access fully unlocked. I'll see you on the 14th! ðŸ’–</p>
        </div>
    </div>

    <!-- ERROR OVERLAY -->
    <div id="error-overlay" class="fixed inset-0 z-[100] hidden items-center justify-center bg-red-950/60 backdrop-blur-xl p-4">
        <div class="bg-white p-10 max-w-xs w-full border-[6px] border-red-600 text-red-600 text-center shadow-[0_0_50px_rgba(220,38,38,0.5)]">
            <i data-lucide="alert-octagon" class="w-16 h-16 mx-auto mb-4 shake"></i>
            <h3 class="font-black text-3xl mb-2 tracking-tighter italic">FATAL ERROR</h3>
            <p id="error-msg" class="font-bold text-xs mb-8 uppercase leading-relaxed">System failure: Redirecting to compliance mode.</p>
            <button onclick="closeError()" class="w-full bg-red-600 text-white py-4 font-black uppercase text-sm tracking-[0.2em] hover:bg-red-700 active:scale-95 transition-all">Retry System</button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Your exact Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAHTA1_SV4zJHdY7cPxrIFWywYwQ_WJkJo",
            authDomain: "bemyvalentine-28efd.firebaseapp.com",
            projectId: "bemyvalentine-28efd",
            storageBucket: "bemyvalentine-28efd.firebasestorage.app",
            messagingSenderId: "288738654455",
            appId: "1:288738654455:web:dc03d21bef1a8f6a047bf2",
            measurementId: "G-CB8KGXBZHM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'valentine-2026';

        let currentPhoto = null;
        let yesScale = 1;
        let errorCount = 0;
        const messages = [
            "Nice try. Try again.",
            "Access Denied: High levels of affection detected.",
            "System Error: Redirecting to 'Yes'...",
            "HEART.EXE NOT RESPONDING: SELECT YES TO REBOOT"
        ];

        // Initialize Icons
        lucide.createIcons();

        // Step Management
        window.showStep = (stepId) => {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            const target = document.getElementById('step-' + stepId);
            target.classList.add('active');
            lucide.createIcons(); // Refresh icons for new step
        };

        // Photo Handling
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentPhoto = event.target.result;
                    document.getElementById('photo-preview').src = currentPhoto;
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('upload-prompt').classList.add('hidden');
                    const btn = document.getElementById('auth-btn');
                    btn.disabled = false;
                    btn.classList.remove('bg-white/5', 'text-white/20', 'cursor-not-allowed');
                    btn.classList.add('bg-pink-600', 'text-white', 'shadow-[0_0_30px_rgba(219,39,119,0.3)]', 'hover:bg-pink-500');
                };
                reader.readAsDataURL(file);
            }
        });

        window.goToQuiz = () => showStep('quiz');
        window.goToValentine = () => showStep('valentine');

        window.moveNo = () => {
            const btn = document.getElementById('noBtn');
            const x = Math.random() * (window.innerWidth - btn.offsetWidth);
            const y = Math.random() * (window.innerHeight - btn.offsetHeight);
            btn.style.position = 'fixed';
            btn.style.left = Math.max(10, Math.min(x, window.innerWidth - 100)) + 'px';
            btn.style.top = Math.max(10, Math.min(y, window.innerHeight - 50)) + 'px';
        };

        window.triggerError = () => {
            document.body.classList.add('critical-bg');
            document.getElementById('error-overlay').classList.replace('hidden', 'flex');
            document.getElementById('error-msg').innerText = messages[errorCount % messages.length];
            errorCount++;
            lucide.createIcons();
        };

        window.closeError = () => {
            document.body.classList.remove('critical-bg');
            document.getElementById('error-overlay').classList.replace('flex', 'hidden');
            yesScale += 0.4;
            document.getElementById('yesBtn').style.transform = `scale(${yesScale})`;
        };

        window.celebrate = async () => {
            showStep('success');
            document.body.style.background = 'linear-gradient(to bottom right, #db2777, #e11d48)';
            
            // Save Data to Firestore
            try {
                await signInAnonymously(auth);
                // Rule 1: Use specific path /artifacts/{appId}/public/data/{collectionName}
                const path = collection(db, 'artifacts', appId, 'public', 'data', 'responses');
                await addDoc(path, {
                    photo_data: currentPhoto,
                    answers: {
                        location: document.getElementById('q-loc').value,
                        date: document.getElementById('q-date').value,
                        kids_count: document.getElementById('q-kids').value
                    },
                    timestamp: new Date().toISOString()
                });
            } catch (e) { 
                console.error("Storage Log:", e); 
            }
        };
    </script>
</body>
</html>